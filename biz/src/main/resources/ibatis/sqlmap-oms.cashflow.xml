<?xml version="1.0" encoding="GB2312"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="oms.cashflow">
	
	<typeAlias alias="cashflow" type="com.hsh24.sync.api.oms.bo.Cashflow" />
	
	<update id="createCashflow" parameterClass="cashflow">
	<![CDATA[
		INSERT
		INTO dms_tb_cashflow
		  (
			CASHFLOW_CID,
			SHOP_ID,
			BANK_ACCT_ID,
			SUMMARY,
			CR_AMOUNT,
			DR_AMOUNT,
			TRADE_DATE,
			TRADE_NO,
			STATE,
			CREATE_DATE,
			CREATE_USER,
			MODIFY_DATE,
			MODIFY_USER
		  )
		  (
			SELECT '3',
				   t.shop_id,
				   p.bank_acct_id,
				   CONCAT('[退款] 采购订单:', t.trade_no, '取消。'),
				   0,
				   t.trade_price,
				   NOW(),
				   t.trade_no,
				   'U',
				   NOW(),
					#modifyUser#,
				   NOW(),
					#modifyUser#
			  FROM dms_tb_trade t,
				   dms_tb_bank_account p,
				   dms_tb_account q
			 WHERE t.shop_id = p.shop_id
			   AND t.shop_id = q.shop_id
			   AND p.acc_id = q.acc_id
			   AND q.acc_code = '1001'
			   AND t.state = 'U'
			   AND p.state = 'U'
			   AND q.state = 'U'
			   AND t.trade_id = #tradeId#
		  )
	]]>
		<selectKey resultClass="java.lang.Long" keyProperty="cashflowId">
		<![CDATA[
			SELECT LAST_INSERT_ID()
		]]>
		</selectKey>
	</update>
	
</sqlMap>